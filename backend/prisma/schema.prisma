// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  name          String?
  googleId      String   @unique
  accessToken   String?
  refreshToken  String?
  tokenExpiry   DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  processedEmails ProcessedEmail[]
  schedules       ScheduleData[]
  routePlans      RoutePlan[]
  weatherData     WeatherData[]
  calendarEvents  CalendarEvent[]
  userConfig      UserConfig?
  notifications   Notification[]
  summaries       Summary[]

  @@map("users")
}

model ProcessedEmail {
  id               String   @id @default(cuid())
  messageId        String   @unique
  subject          String
  sender           String
  receivedAt       DateTime
  threadId         String?
  processed        Boolean  @default(false)
  processingStatus String   @default("pending")
  pdfHash          String?
  error            String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  userId           String
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  schedule         ScheduleData?

  @@map("processed_emails")
}

model ScheduleData {
  id            String   @id @default(cuid())
  shootingDate  DateTime
  callTime      String
  location      String
  baseLocation  String?
  sceneType     String
  scenes        Json?
  safetyNotes   String?
  equipment     Json?
  contacts      Json?
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  emailId       String   @unique
  email         ProcessedEmail @relation(fields: [emailId], references: [id], onDelete: Cascade)

  routePlan     RoutePlan?
  weatherData   WeatherData?
  calendarEvent CalendarEvent?
  summary       Summary?

  @@map("schedule_data")
}

model RoutePlan {
  id                  String   @id @default(cuid())
  wakeUpTime          DateTime
  departureTime       DateTime
  arrivalTime         DateTime
  totalTravelMinutes  Int
  routeSegments       Json
  buffers             Json
  calculatedAt        DateTime @default(now())

  userId              String
  user                User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  scheduleId          String       @unique
  schedule            ScheduleData @relation(fields: [scheduleId], references: [id], onDelete: Cascade)

  @@map("route_plans")
}

model WeatherData {
  id            String   @id @default(cuid())
  forecastDate  DateTime
  temperature   Float?
  description   String?
  windSpeed     Float?
  precipitation Float?
  humidity      Int?
  warnings      Json?
  fetchedAt     DateTime @default(now())

  userId        String
  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  scheduleId    String       @unique
  schedule      ScheduleData @relation(fields: [scheduleId], references: [id], onDelete: Cascade)

  @@map("weather_data")
}

model CalendarEvent {
  id                String   @id @default(cuid())
  calendarEventId   String
  title             String
  startTime         DateTime
  endTime           DateTime
  description       String?
  location          String?
  createdAt         DateTime @default(now())

  userId            String
  user              User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  scheduleId        String       @unique
  schedule          ScheduleData @relation(fields: [scheduleId], references: [id], onDelete: Cascade)

  @@map("calendar_events")
}

model UserConfig {
  id                    String @id @default(cuid())
  homeAddress           String
  panavisionAddress     String
  bufferCarChange       Int    @default(15)
  bufferParking         Int    @default(10)
  bufferEntry           Int    @default(10)
  bufferTraffic         Int    @default(20)
  bufferMorningRoutine  Int    @default(45)
  notificationEmail     Boolean @default(true)
  notificationSMS       Boolean @default(false)
  notificationPush      Boolean @default(true)
  smsNumber             String?
  smsVerified           Boolean @default(false)
  smsVerificationCode   String?
  smsVerificationExpiry DateTime?
  pushToken             String?
  pushTokenVerified     Boolean @default(false)

  userId                String @unique
  user                  User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_configs")
}

model Notification {
  id            String   @id @default(cuid())
  channel       String   // email, sms, push
  template      String   // schedule_processed, weather_warning, etc.
  subject       String
  message       String   @db.Text
  data          Json?
  scheduledFor  DateTime?
  sentAt        DateTime?
  status        String   @default("pending") // pending, sent, failed, cancelled
  error         String?
  retryCount    Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model Summary {
  id            String   @id @default(cuid())
  language      String   @default("en") // en, pl
  content       String   @db.Text
  htmlContent   String   @db.Text
  timeline      Json
  weatherSummary String?
  warnings      Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  userId        String
  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  scheduleId    String       @unique
  schedule      ScheduleData @relation(fields: [scheduleId], references: [id], onDelete: Cascade)

  @@map("summaries")
}