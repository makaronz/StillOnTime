groups:
  # High-level service availability alerts
  - name: stillontime.availability
    rules:
      - alert: ServiceDown
        expr: up == 0
        for: 1m
        labels:
          severity: critical
          service: "{{ $labels.job }}"
        annotations:
          summary: "Service {{ $labels.job }} is down"
          description: "Service {{ $labels.job }} has been down for more than 1 minute."
          runbook_url: "https://docs.stillontime.com/runbooks/service-down"

      - alert: HighErrorRate
        expr: stillontime:error_rate_5m > 0.05
        for: 5m
        labels:
          severity: warning
          service: "{{ $labels.service }}"
        annotations:
          summary: "High error rate detected for {{ $labels.service }}"
          description: "Error rate for {{ $labels.service }} is {{ $value | humanizePercentage }} over the last 5 minutes."
          runbook_url: "https://docs.stillontime.com/runbooks/high-error-rate"

      - alert: CriticalErrorRate
        expr: stillontime:error_rate_5m > 0.20
        for: 2m
        labels:
          severity: critical
          service: "{{ $labels.service }}"
        annotations:
          summary: "Critical error rate detected for {{ $labels.service }}"
          description: "Error rate for {{ $labels.service }} is {{ $value | humanizePercentage }} over the last 5 minutes."
          runbook_url: "https://docs.stillontime.com/runbooks/critical-error-rate"

      - alert: SlowResponseTime
        expr: stillontime:response_time_p95_5m > 2
        for: 5m
        labels:
          severity: warning
          service: "{{ $labels.service }}"
        annotations:
          summary: "Slow response times for {{ $labels.service }}"
          description: "95th percentile response time for {{ $labels.service }} is {{ $value }}s over the last 5 minutes."
          runbook_url: "https://docs.stillontime.com/runbooks/slow-response-time"

  # Database health alerts
  - name: stillontime.database
    rules:
      - alert: PostgreSQLDown
        expr: pg_up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "PostgreSQL instance is down"
          description: "PostgreSQL database on {{ $labels.instance }} has been down for more than 1 minute."
          runbook_url: "https://docs.stillontime.com/runbooks/postgresql-down"

      - alert: PostgreSQLHighConnections
        expr: stillontime:db_pool_usage > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "PostgreSQL connection pool usage is high"
          description: "PostgreSQL connection pool usage is {{ $value }}% on {{ $labels.instance }}."
          runbook_url: "https://docs.stillontime.com/runbooks/postgresql-high-connections"

      - alert: PostgreSQLSlowQueries
        expr: pg_stat_activity_max_tx_duration > 300
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "PostgreSQL has slow running queries"
          description: "PostgreSQL has queries running for more than 5 minutes on {{ $labels.instance }}."
          runbook_url: "https://docs.stillontime.com/runbooks/postgresql-slow-queries"

      - alert: PostgreSQLReplicationLag
        expr: pg_replication_lag > 60
        for: 3m
        labels:
          severity: warning
        annotations:
          summary: "PostgreSQL replication lag is high"
          description: "PostgreSQL replication lag is {{ $value }}s on {{ $labels.instance }}."
          runbook_url: "https://docs.stillontime.com/runbooks/postgresql-replication-lag"

  # Redis health alerts
  - name: stillontime.redis
    rules:
      - alert: RedisDown
        expr: redis_up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Redis instance is down"
          description: "Redis instance on {{ $labels.instance }} has been down for more than 1 minute."
          runbook_url: "https://docs.stillontime.com/runbooks/redis-down"

      - alert: RedisHighMemoryUsage
        expr: stillontime:redis_memory_usage_percentage > 90
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Redis memory usage is high"
          description: "Redis memory usage is {{ $value }}% on {{ $labels.instance }}."
          runbook_url: "https://docs.stillontime.com/runbooks/redis-high-memory"

      - alert: RedisSlowLog
        expr: redis_slowlog_length > 10
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Redis slow log is growing"
          description: "Redis slow log has {{ $value }} entries on {{ $labels.instance }}."
          runbook_url: "https://docs.stillontime.com/runbooks/redis-slow-log"

  # Kubernetes infrastructure alerts
  - name: stillontime.kubernetes
    rules:
      - alert: KubernetesPodCrashLooping
        expr: rate(kube_pod_container_status_restarts_total[15m]) > 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Pod {{ $labels.pod }} is crash looping"
          description: "Pod {{ $labels.pod }} in namespace {{ $labels.namespace }} is restarting {{ $value | humanize }} times per minute."
          runbook_url: "https://docs.stillontime.com/runbooks/pod-crash-looping"

      - alert: KubernetesPodNotReady
        expr: kube_pod_status_ready{condition="false"} == 1
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Pod {{ $labels.pod }} is not ready"
          description: "Pod {{ $labels.pod }} in namespace {{ $labels.namespace }} has been not ready for more than 10 minutes."
          runbook_url: "https://docs.stillontime.com/runbooks/pod-not-ready"

      - alert: KubernetesNodeNotReady
        expr: kube_node_status_condition{condition="Ready",status="true"} == 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Node {{ $labels.node }} is not ready"
          description: "Node {{ $labels.node }} has been not ready for more than 5 minutes."
          runbook_url: "https://docs.stillontime.com/runbooks/node-not-ready"

      - alert: KubernetesHighCPUUsage
        expr: stillontime:cpu_usage_by_container > 80
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "High CPU usage in container {{ $labels.container }}"
          description: "Container {{ $labels.container }} in pod {{ $labels.pod }} is using {{ $value }}% CPU."
          runbook_url: "https://docs.stillontime.com/runbooks/high-cpu-usage"

      - alert: KubernetesHighMemoryUsage
        expr: stillontime:memory_usage_by_container > 1024
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "High memory usage in container {{ $labels.container }}"
          description: "Container {{ $labels.container }} in pod {{ $labels.pod }} is using {{ $value }}MB memory."
          runbook_url: "https://docs.stillontime.com/runbooks/high-memory-usage"

  # Application-specific alerts
  - name: stillontime.application
    rules:
      - alert: ScheduleProcessingFailures
        expr: increase(schedule_processing_failures_total[5m]) > 5
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "High number of schedule processing failures"
          description: "There have been {{ $value }} schedule processing failures in the last 5 minutes."
          runbook_url: "https://docs.stillontime.com/runbooks/schedule-processing-failures"

      - alert: EmailProcessingBacklog
        expr: email_processing_queue_size > 100
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Email processing backlog is high"
          description: "Email processing queue has {{ $value }} pending emails."
          runbook_url: "https://docs.stillontime.com/runbooks/email-processing-backlog"

      - alert: GoogleAPIQuotaExceeded
        expr: increase(google_api_quota_exceeded_total[1h]) > 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Google API quota exceeded"
          description: "Google API quota has been exceeded {{ $value }} times in the last hour."
          runbook_url: "https://docs.stillontime.com/runbooks/google-api-quota"

      - alert: WeatherAPIDown
        expr: weather_api_success_rate < 0.95
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Weather API success rate is low"
          description: "Weather API success rate is {{ $value | humanizePercentage }} over the last 5 minutes."
          runbook_url: "https://docs.stillontime.com/runbooks/weather-api-down"

  # Security alerts
  - name: stillontime.security
    rules:
      - alert: HighAuthenticationFailures
        expr: increase(authentication_failures_total[5m]) > 20
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "High number of authentication failures"
          description: "There have been {{ $value }} authentication failures in the last 5 minutes."
          runbook_url: "https://docs.stillontime.com/runbooks/high-auth-failures"

      - alert: SuspiciousActivity
        expr: increase(security_incidents_total{severity="high"}[5m]) > 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "High severity security incident detected"
          description: "{{ $value }} high severity security incidents detected in the last 5 minutes."
          runbook_url: "https://docs.stillontime.com/runbooks/security-incident"

      - alert: RateLimitViolations
        expr: increase(rate_limit_violations_total[5m]) > 50
        for: 3m
        labels:
          severity: warning
        annotations:
          summary: "High number of rate limit violations"
          description: "There have been {{ $value }} rate limit violations in the last 5 minutes."
          runbook_url: "https://docs.stillontime.com/runbooks/rate-limit-violations"

  # SSL certificate alerts
  - name: stillontime.ssl
    rules:
      - alert: SSLCertificateExpiringSoon
        expr: probe_ssl_earliest_cert_expiry - time() < 86400 * 7
        for: 1h
        labels:
          severity: warning
        annotations:
          summary: "SSL certificate expiring soon for {{ $labels.instance }}"
          description: "SSL certificate for {{ $labels.instance }} expires in {{ $value | humanizeDuration }}."
          runbook_url: "https://docs.stillontime.com/runbooks/ssl-certificate-expiring"

      - alert: SSLCertificateExpired
        expr: probe_ssl_earliest_cert_expiry - time() <= 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "SSL certificate expired for {{ $labels.instance }}"
          description: "SSL certificate for {{ $labels.instance }} has expired."
          runbook_url: "https://docs.stillontime.com/runbooks/ssl-certificate-expired"

  # Business metrics alerts
  - name: stillontime.business
    rules:
      - alert: LowUserActivity
        expr: active_users_1h < 5
        for: 30m
        labels:
          severity: warning
        annotations:
          summary: "Low user activity detected"
          description: "Only {{ $value }} active users in the last hour."
          runbook_url: "https://docs.stillontime.com/runbooks/low-user-activity"

      - alert: ScheduleProcessingEfficiencyDrop
        expr: schedule_processing_efficiency < 0.8
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: "Schedule processing efficiency has dropped"
          description: "Schedule processing efficiency is {{ $value | humanizePercentage }}."
          runbook_url: "https://docs.stillontime.com/runbooks/schedule-efficiency-drop"

  # External dependency alerts
  - name: stillontime.external
    rules:
      - alert: ExternalServiceDown
        expr: probe_success == 0
        for: 3m
        labels:
          severity: warning
        annotations:
          summary: "External service {{ $labels.instance }} is down"
          description: "External service {{ $labels.instance }} has been unreachable for more than 3 minutes."
          runbook_url: "https://docs.stillontime.com/runbooks/external-service-down"

      - alert: ExternalServiceSlowResponse
        expr: probe_duration_seconds > 5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "External service {{ $labels.instance }} is responding slowly"
          description: "External service {{ $labels.instance }} response time is {{ $value }}s."
          runbook_url: "https://docs.stillontime.com/runbooks/external-service-slow"

  # Backup and disaster recovery alerts
  - name: stillontime.backup
    rules:
      - alert: BackupFailed
        expr: backup_last_success_timestamp < time() - 86400
        for: 1h
        labels:
          severity: critical
        annotations:
          summary: "Backup has failed"
          description: "No successful backup completed in the last 24 hours."
          runbook_url: "https://docs.stillontime.com/runbooks/backup-failed"

      - alert: BackupSizeAnomaly
        expr: abs(backup_size_bytes - backup_size_bytes offset 24h) / backup_size_bytes offset 24h > 0.5
        for: 30m
        labels:
          severity: warning
        annotations:
          summary: "Backup size anomaly detected"
          description: "Backup size has changed by {{ $value | humanizePercentage }} compared to yesterday."
          runbook_url: "https://docs.stillontime.com/runbooks/backup-size-anomaly"